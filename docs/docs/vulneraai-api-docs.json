{
  "siteTitle": "VulneraAI API Справочник",
  "pages": [
    {
      "id": "overview",
      "title": "Обзор API",
      "order": 10,
      "content": "# Обзор VulneraAI API\n\nVulneraAI Server v1.0.0 представляет собой комплексную платформу для автоматизированного тестирования безопасности веб-приложений на базе искусственного интеллекта. API предоставляет полный набор инструментов для управления процессом пентестирования, анализа уязвимостей и интеграции с внешними системами мониторинга и обработки инцидентов.\n\nПлатформа разработана для работы с современными архитектурами и CI/CD конвейерами, позволяя автоматизировать процесс безопасности на каждом этапе разработки. Все компоненты системы построены с учётом масштабируемости, надёжности и производительности, обеспечивая обработку тысяч одновременных тестов без деградации качества.\n\n## Базовые URL\n\nДоступны два основных окружения для работы с API:\n\n- Локальная разработка: `http://localhost:8000` - используется для локального тестирования и разработки\n- Production: `https://api.vulneraai.io` - основной сервис для работы в production окружении\n\nДля всех примеров в этой документации используется Production URL, но вы можете заменить его на локальный адрес при разработке.\n\n## Концепция безопасности и аутентификации\n\nVulneraAI использует современные методы аутентификации для защиты API от несанкционированного доступа. Все защищённые endpoints требуют HTTP Bearer аутентификацию с использованием JWT токенов или API ключей.\n\nСистема поддерживает два типа аутентификации:\n\n1. JWT токены (Access + Refresh) - предназначены для веб-приложений и мобильных клиентов, имеют короткое время жизни (1 час) и требуют периодического обновления через refresh токен. Этот подход обеспечивает высокий уровень безопасности, так как скомпрометированный токен действует ограниченное время.\n\n2. API ключи (долгоживущие) - предназначены для скриптов, CI/CD конвейеров и долгосрочных интеграций. API ключи имеют более длительное время жизни (до 1 года) но требуют более тщательного управления и ротации.\n\n## Жизненный цикл пентеста\n\nКаждый пентест проходит через несколько этапов:\n\n1. **Created** - пентест создан но не запущен\n2. **Queued** - пентест добавлен в очередь на выполнение\n3. **Running** - агенты активно выполняют сканирование\n4. **Processing** - анализ результатов и генерирование отчёта\n5. **Completed** - пентест завершён, результаты доступны\n6. **Failed** - ошибка при выполнении\n\nВы можете мониторить статус пентеста в реальном времени через API или WebSocket.\n\n## HTTP коды состояния\n\nAPI использует стандартные HTTP коды для обозначения результатов операций:\n\n- **200 OK** - операция выполнена успешно\n- **201 Created** - ресурс успешно создан\n- **400 Bad Request** - неверные параметры запроса\n- **401 Unauthorized** - отсутствует или невалидна аутентификация\n- **403 Forbidden** - доступ запрещён\n- **404 Not Found** - ресурс не найден\n- **429 Too Many Requests** - превышен лимит запросов\n- **500 Internal Server Error** - внутренняя ошибка сервера\n\n## Формат запросов и ответов\n\nВсе запросы и ответы используют формат JSON с кодировкой UTF-8. Примеры запросов должны включать необходимые заголовки:\n\n```\nContent-Type: application/json\nAuthorization: Bearer <token>\n```\n\nОтветы от API содержат JSON объект с полями:\n- `success` - булево значение успеха операции\n- `data` - основные данные ответа\n- `error` - описание ошибки (если applicable)\n- `timestamp` - время генерирования ответа\n\n## Rate Limiting\n\nAPI имеет ограничения на количество запросов для предотвращения abuse:\n\n- Бесплатный tier: 100 запросов в минуту\n- Pro tier: 1000 запросов в минуту\n- Enterprise tier: unlimited\n\nИнформация о текущих лимитах передаётся в заголовках ответа:\n- `X-RateLimit-Limit` - максимальное количество запросов\n- `X-RateLimit-Remaining` - осталось запросов\n- `X-RateLimit-Reset` - время сброса лимита\n\nПри превышении лимита API вернёт 429 status с временем восстановления доступа."
    },
    {
      "id": "authentication",
      "title": "Аутентификация и управление доступом",
      "order": 20,
      "content": "# Аутентификация и управление доступом\n\n## JWT токены\n\nJWT (JSON Web Token) токены используются для аутентификации в веб-приложениях и мобильных клиентах.\n\n### Получение JWT токена\n\nОтправить POST запрос на `/api/v1/auth/login` с учётными данными:\n\n```\nPOST /api/v1/auth/login\nContent-Type: application/json\n\n{\n  \"email\": \"user@example.com\",\n  \"password\": \"secure_password\"\n}\n```\n\nОтвет содержит access и refresh токены:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n    \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n    \"expires_in\": 3600,\n    \"user\": {\n      \"id\": \"user_123\",\n      \"email\": \"user@example.com\",\n      \"name\": \"John Doe\"\n    }\n  }\n}\n```\n\n### Использование JWT токена\n\nВключить токен в заголовок `Authorization`:\n\n```\nGET /api/v1/pentests\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\n```\n\n### Refresh токен\n\nAccess токен действует 1 час, после чего требуется обновление через refresh токен:\n\n```\nPOST /api/v1/auth/refresh\nContent-Type: application/json\n\n{\n  \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\n}\n```\n\nОтвет содержит новый access токен:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n    \"expires_in\": 3600\n  }\n}\n```\n\n## API ключи\n\nAPI ключи используются для долгосрочных интеграций в скриптах и CI/CD конвейерах.\n\n### Создание API ключа\n\nОбратиться к административному интерфейсу или вызвать:\n\n```\nPOST /api/v1/users/api-keys\nContent-Type: application/json\nAuthorization: Bearer <access_token>\n\n{\n  \"name\": \"CI/CD Pipeline Key\",\n  \"expires_in_days\": 365,\n  \"scopes\": [\"pentest:create\", \"pentest:read\", \"results:read\"]\n}\n```\n\nОтвет:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"api_key\": \"vul_sk_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\",\n    \"name\": \"CI/CD Pipeline Key\",\n    \"created_at\": \"2025-12-13T09:00:00Z\",\n    \"expires_at\": \"2026-12-13T09:00:00Z\"\n  }\n}\n```\n\n### Использование API ключа\n\nВключить ключ в заголовок `Authorization`:\n\n```\nGET /api/v1/pentests\nAuthorization: Bearer vul_sk_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\n```\n\nИли в query параметре (не рекомендуется):\n\n```\nGET /api/v1/pentests?api_key=vul_sk_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6\n```\n\n## Scopes и права доступа\n\nAPI ключи и приложения могут иметь ограниченные права доступа через scopes:\n\n- `pentest:create` - создание новых пентестов\n- `pentest:read` - чтение информации о пентестах\n- `pentest:update` - редактирование пентестов\n- `pentest:delete` - удаление пентестов\n- `results:read` - чтение результатов сканирования\n- `webhooks:manage` - управление вебхуками\n- `reports:generate` - генерирование отчётов\n- `admin:users` - управление пользователями\n\nПри обращении к endpoint'у без необходимого scope, API вернёт 403 Forbidden.\n\n## Best practices\n\n### 1. Никогда не передавайте токены в URL\n```\n❌ GET /api/v1/pentests?token=...\n✅ GET /api/v1/pentests\n   Authorization: Bearer ...\n```\n\n### 2. Используйте HTTPS для всех запросов\nНикогда не передавайте токены через HTTP.\n\n### 3. Ротируйте API ключи регулярно\nСмена ключей каждые 3-6 месяцев снижает риск компрометации.\n\n### 4. Используйте разные ключи для разных окружений\nОтдельные ключи для development, staging и production.\n\n### 5. Используйте минимально необходимые scopes\nДавайте приложениям только нужные права доступа.\n\n### 6. Мониторьте использование ключей\nОтслеживайте когда и откуда используются ключи.\n\n### 7. Немедленно отзывайте скомпрометированные ключи\nПри подозрении на утечку удалите ключ и создайте новый.\n\n## Обработка ошибок аутентификации\n\n### 401 Unauthorized - отсутствует токен\n\n```json\n{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"UNAUTHORIZED\",\n    \"message\": \"Missing or invalid Authorization header\"\n  }\n}\n```\n\n### 401 Unauthorized - невалидный токен\n\n```json\n{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"INVALID_TOKEN\",\n    \"message\": \"Token has expired or is invalid\"\n  }\n}\n```\n\n### 403 Forbidden - недостаточно прав\n\n```json\n{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"INSUFFICIENT_PERMISSIONS\",\n    \"message\": \"This operation requires 'pentest:create' scope\"\n  }\n}\n```"
    },
    {
      "id": "pentests",
      "title": "Управление пентестами и сканированием",
      "order": 30,
      "content": "# Управление пентестами и сканированием\n\n## Создание пентеста\n\nPOST запрос на `/api/v1/pentests` с параметрами целевого приложения:\n\n```\nPOST /api/v1/pentests\nContent-Type: application/json\nAuthorization: Bearer <token>\n\n{\n  \"name\": \"E-commerce Platform Test\",\n  \"target_url\": \"https://shop.example.com\",\n  \"intensity\": \"high\",\n  \"scan_type\": \"full\",\n  \"vulnerability_types\": [\n    \"sql_injection\",\n    \"xss\",\n    \"csrf\",\n    \"authentication_bypass\",\n    \"business_logic\"\n  ],\n  \"webhook_url\": \"https://webhook.example.com/vulneraai\",\n  \"schedule\": {\n    \"recurring\": \"weekly\",\n    \"day_of_week\": \"sunday\",\n    \"time\": \"02:00\"\n  }\n}\n```\n\nПараметры:\n- `name` - название пентеста (строка, обязательно)\n- `target_url` - URL целевого приложения (обязательно)\n- `intensity` - интенсивность сканирования (low, medium, high, aggressive)\n- `scan_type` - тип сканирования (quick, full, api, mobile)\n- `vulnerability_types` - массив типов уязвимостей для поиска\n- `webhook_url` - URL для отправки уведомлений о событиях\n- `schedule` - параметры расписания для периодических пентестов\n\nОтвет:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"id\": \"pentest_abc123def456\",\n    \"name\": \"E-commerce Platform Test\",\n    \"target_url\": \"https://shop.example.com\",\n    \"status\": \"created\",\n    \"created_at\": \"2025-12-13T09:00:00Z\",\n    \"started_at\": null,\n    \"completed_at\": null\n  }\n}\n```\n\n## Получение списка пентестов\n\nGET запрос на `/api/v1/pentests` для получения списка:\n\n```\nGET /api/v1/pentests?status=running&intensity=high&limit=10&offset=0\nAuthorization: Bearer <token>\n```\n\nQuery параметры:\n- `status` - фильтр по статусу (created, queued, running, processing, completed, failed)\n- `intensity` - фильтр по интенсивности\n- `limit` - количество результатов (по умолчанию 20, максимум 100)\n- `offset` - смещение для пагинации\n- `sort_by` - сортировка (created_at, status, intensity)\n\nОтвет:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"total\": 42,\n    \"limit\": 10,\n    \"offset\": 0,\n    \"pentests\": [\n      {\n        \"id\": \"pentest_123\",\n        \"name\": \"E-commerce Platform Test\",\n        \"target_url\": \"https://shop.example.com\",\n        \"status\": \"running\",\n        \"intensity\": \"high\",\n        \"progress\": 45,\n        \"vulnerabilities_found\": 12,\n        \"created_at\": \"2025-12-13T09:00:00Z\",\n        \"started_at\": \"2025-12-13T09:05:00Z\"\n      }\n    ]\n  }\n}\n```\n\n## Мониторинг статуса пентеста\n\nGET запрос на `/api/v1/pentests/{pentest_id}` для получения деталей:\n\n```\nGET /api/v1/pentests/pentest_abc123def456\nAuthorization: Bearer <token>\n```\n\nОтвет:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"id\": \"pentest_abc123def456\",\n    \"name\": \"E-commerce Platform Test\",\n    \"target_url\": \"https://shop.example.com\",\n    \"status\": \"running\",\n    \"progress\": 45,\n    \"intensity\": \"high\",\n    \"created_at\": \"2025-12-13T09:00:00Z\",\n    \"started_at\": \"2025-12-13T09:05:00Z\",\n    \"estimated_completion\": \"2025-12-13T12:30:00Z\",\n    \"vulnerabilities_found\": 12,\n    \"agents_assigned\": 5,\n    \"requests_sent\": 2341,\n    \"responses_received\": 2341,\n    \"bytes_transferred\": 2341000\n  }\n}\n```\n\n## WebSocket для real-time обновлений\n\nПодключиться к WebSocket для получения live обновлений:\n\n```\nWebSocket: wss://api.vulneraai.io/ws/pentests/{pentest_id}?token=<access_token>\n```\n\nСообщения от сервера:\n\n```json\n{\n  \"event\": \"progress_updated\",\n  \"data\": {\n    \"progress\": 50,\n    \"vulnerabilities_found\": 15,\n    \"last_update\": \"2025-12-13T09:15:00Z\"\n  }\n}\n```\n\n```json\n{\n  \"event\": \"vulnerability_found\",\n  \"data\": {\n    \"id\": \"vuln_123\",\n    \"title\": \"SQL Injection in Search\",\n    \"severity\": \"high\",\n    \"cwe\": \"CWE-89\",\n    \"location\": \"/search?q=test\"\n  }\n}\n```\n\n## Получение результатов\n\nGET запрос на `/api/v1/pentests/{pentest_id}/results`:\n\n```\nGET /api/v1/pentests/pentest_abc123def456/results?severity=high&limit=50\nAuthorization: Bearer <token>\n```\n\nQuery параметры:\n- `severity` - фильтр по серьёзности (critical, high, medium, low, info)\n- `type` - тип уязвимости (sql_injection, xss, csrf, и т.д.)\n- `limit` - количество результатов\n- `offset` - смещение для пагинации\n\nОтвет:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"total\": 12,\n    \"summary\": {\n      \"critical\": 1,\n      \"high\": 3,\n      \"medium\": 5,\n      \"low\": 3,\n      \"info\": 0\n    },\n    \"vulnerabilities\": [\n      {\n        \"id\": \"vuln_123\",\n        \"title\": \"SQL Injection in Login\",\n        \"description\": \"The login endpoint is vulnerable to SQL injection\",\n        \"severity\": \"critical\",\n        \"cvss_score\": 9.8,\n        \"cwe\": \"CWE-89\",\n        \"location\": \"/api/login\",\n        \"payload\": \"' OR '1'='1\",\n        \"http_request\": \"POST /api/login HTTP/1.1...\",\n        \"http_response\": \"HTTP/1.1 200 OK...\",\n        \"remediation\": \"Use parameterized queries or prepared statements\",\n        \"references\": [\n          \"https://owasp.org/www-community/attacks/SQL_Injection\"\n        ]\n      }\n    ]\n  }\n}\n```\n\n## Генерирование отчётов\n\nPOST запрос на `/api/v1/pentests/{pentest_id}/reports`:\n\n```\nPOST /api/v1/pentests/pentest_abc123def456/reports\nContent-Type: application/json\nAuthorization: Bearer <token>\n\n{\n  \"format\": \"pdf\",\n  \"include_sections\": [\n    \"executive_summary\",\n    \"vulnerabilities\",\n    \"remediation\",\n    \"appendix\"\n  ],\n  \"template\": \"detailed\"\n}\n```\n\nПараметры:\n- `format` - формат отчёта (pdf, html, json, docx)\n- `include_sections` - какие разделы включить в отчёт\n- `template` - шаблон отчёта (detailed, brief, executive)\n\nОтвет:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"report_id\": \"report_xyz789\",\n    \"status\": \"generating\",\n    \"format\": \"pdf\",\n    \"url\": \"https://api.vulneraai.io/reports/report_xyz789.pdf\",\n    \"expires_at\": \"2025-12-20T09:00:00Z\"\n  }\n}\n```\n\n## Отмена пентеста\n\nDELETE запрос на `/api/v1/pentests/{pentest_id}`:\n\n```\nDELETE /api/v1/pentests/pentest_abc123def456\nAuthorization: Bearer <token>\n```\n\nОтвет:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"message\": \"Pentest cancelled successfully\"\n  }\n}\n```\n\n## Статистика и аналитика\n\nGET запрос на `/api/v1/analytics/pentests`:\n\n```\nGET /api/v1/analytics/pentests?period=month&metric=vulnerabilities_by_severity\nAuthorization: Bearer <token>\n```\n\nОтвет:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"period\": \"month\",\n    \"metric\": \"vulnerabilities_by_severity\",\n    \"data\": {\n      \"critical\": 5,\n      \"high\": 23,\n      \"medium\": 87,\n      \"low\": 156,\n      \"info\": 342\n    },\n    \"trend\": {\n      \"week_1\": 32,\n      \"week_2\": 45,\n      \"week_3\": 78,\n      \"week_4\": 98\n    }\n  }\n}\n```"
    },
    {
      "id": "webhooks",
      "title": "Вебхуки и push уведомления",
      "order": 40,
      "content": "# Вебхуки и push уведомления\n\n## Создание вебхука\n\nPOST запрос на `/api/v1/webhooks` для создания вебхука:\n\n```\nPOST /api/v1/webhooks\nContent-Type: application/json\nAuthorization: Bearer <token>\n\n{\n  \"url\": \"https://webhook.example.com/vulneraai\",\n  \"events\": [\n    \"pentest.created\",\n    \"pentest.started\",\n    \"pentest.completed\",\n    \"vulnerability.found\",\n    \"vulnerability.critical\"\n  ],\n  \"active\": true,\n  \"retry_config\": {\n    \"max_retries\": 5,\n    \"retry_delay\": 60,\n    \"timeout\": 30\n  }\n}\n```\n\nПараметры:\n- `url` - URL для отправки вебхуков (обязательно)\n- `events` - массив событий для подписки (обязательно)\n- `active` - активен ли вебхук (по умолчанию true)\n- `retry_config` - конфигурация повторов\n\nОтвет:\n\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"id\": \"webhook_123abc\",\n    \"url\": \"https://webhook.example.com/vulneraai\",\n    \"events\": [...],\n    \"active\": true,\n    \"created_at\": \"2025-12-13T09:00:00Z\"\n  }\n}\n```\n\n## События вебхуков\n\n### pentest.created\nГенерируется при создании нового пентеста.\n\nPayload:\n```json\n{\n  \"event\": \"pentest.created\",\n  \"pentest_id\": \"pentest_123\",\n  \"name\": \"Test Name\",\n  \"target_url\": \"https://example.com\",\n  \"intensity\": \"high\",\n  \"created_at\": \"2025-12-13T09:00:00Z\"\n}\n```\n\n### pentest.started\nГенерируется при начале пентеста.\n\nPayload:\n```json\n{\n  \"event\": \"pentest.started\",\n  \"pentest_id\": \"pentest_123\",\n  \"started_at\": \"2025-12-13T09:05:00Z\",\n  \"agents_assigned\": 5\n}\n```\n\n### pentest.completed\nГенерируется при завершении пентеста.\n\nPayload:\n```json\n{\n  \"event\": \"pentest.completed\",\n  \"pentest_id\": \"pentest_123\",\n  \"completed_at\": \"2025-12-13T12:30:00Z\",\n  \"vulnerabilities_found\": 15,\n  \"critical\": 2,\n  \"high\": 5,\n  \"medium\": 8\n}\n```\n\n### vulnerability.found\nГенерируется при обнаружении каждой новой уязвимости.\n\nPayload:\n```json\n{\n  \"event\": \"vulnerability.found\",\n  \"pentest_id\": \"pentest_123\",\n  \"vulnerability_id\": \"vuln_456\",\n  \"title\": \"SQL Injection\",\n  \"severity\": \"high\",\n  \"cwe\": \"CWE-89\",\n  \"location\": \"/search?q=test\",\n  \"cvss_score\": 8.6\n}\n```\n\n### vulnerability.critical\nГенерируется только при обнаружении критических уязвимостей.\n\nPayload:\n```json\n{\n  \"event\": \"vulnerability.critical\",\n  \"pentest_id\": \"pentest_123\",\n  \"vulnerability_id\": \"vuln_789\",\n  \"title\": \"Remote Code Execution\",\n  \"severity\": \"critical\",\n  \"cwe\": \"CWE-94\",\n  \"location\": \"/api/upload\",\n  \"cvss_score\": 9.9,\n  \"requires_immediate_action\": true\n}\n```\n\n## Безопасность вебхуков\n\nКаждый вебхук подписывается HMAC-SHA256 подписью. Проверяйте подпись перед обработкой:\n\nЗаголовки вебхука:\n- `X-VulneraAI-Signature` - HMAC-SHA256 подпись\n- `X-VulneraAI-Delivery` - ID доставки события\n- `X-VulneraAI-Timestamp` - Unix timestamp\n\nДля проверки подписи:\n\n```python\nimport hmac\nimport hashlib\n\ndef verify_webhook_signature(payload, signature, secret):\n    expected_signature = 'sha256=' + hmac.new(\n        secret.encode(),\n        payload,\n        hashlib.sha256\n    ).hexdigest()\n\n    return hmac.compare_digest(signature, expected_signature)\n\n# Использование\npayload = request.get_data(as_text=True)\nsignature = request.headers.get('X-VulneraAI-Signature')\nwebhook_secret = 'whsec_...'\n\nif verify_webhook_signature(payload, signature, webhook_secret):\n    # Обработать событие\n    pass\nelse:\n    # Отклонить поддельный вебхук\n    return 401\n```\n\n## Управление вебхуками\n\n### Получение списка вебхуков\n\n```\nGET /api/v1/webhooks\nAuthorization: Bearer <token>\n```\n\n### Обновление вебхука\n\n```\nPATCH /api/v1/webhooks/{webhook_id}\nContent-Type: application/json\nAuthorization: Bearer <token>\n\n{\n  \"active\": false,\n  \"events\": [\"pentest.completed\"]\n}\n```\n\n### Удаление вебхука\n\n```\nDELETE /api/v1/webhooks/{webhook_id}\nAuthorization: Bearer <token>\n```\n\n## Система повторов\n\nПри ошибке доставки вебхук повторяется автоматически с экспоненциальной задержкой:\n\n- Попытка 1: сразу\n- Попытка 2: 60 секунд\n- Попытка 3: 120 секунд\n- Попытка 4: 300 секунд\n- Попытка 5: 600 секунд\n\nПосле 5 неудачных попыток событие помечается как failed.\n\n## Гарантии доставки\n\n- Каждое событие отправляется минимум 1 раз\n- Порядок событий не гарантируется\n- Возможны дубликаты при сетевых ошибках\n- Рекомендуется использовать idempotent ключи\n\n## Best practices\n\n1. Отвечайте 200 OK как можно быстрее\n2. Обрабатывайте события асинхронно в background job\n3. Логируйте все входящие вебхуки для отладки\n4. Проверяйте подписи перед обработкой\n5. Используйте exponential backoff при обработке ошибок\n6. Мониторьте delivery failures в админ-панели"
    },
    {
      "id": "health-metrics",
      "title": "Проверка здоровья и метрики",
      "order": 50,
      "content": "# Проверка здоровья и метрики\n\n## Kubernetes Health Checks\n\n### Liveness Probe\n\nПроверяет живость контейнера. Если проверка не пройдена, Kubernetes перезагружает контейнер.\n\n```\nGET /api/v1/health/live\n```\n\nОтвет при успехе (200 OK):\n```json\n{\n  \"status\": \"alive\",\n  \"timestamp\": \"2025-12-13T09:00:00Z\"\n}\n```\n\nОтвет при ошибке (503 Service Unavailable):\n```json\n{\n  \"status\": \"dead\",\n  \"error\": \"Database connection failed\"\n}\n```\n\n### Readiness Probe\n\nПроверяет готовность контейнера обрабатывать запросы. Если проверка не пройдена, трафик не маршрутизируется на pod.\n\n```\nGET /api/v1/health/ready\n```\n\nОтвет при успехе (200 OK):\n```json\n{\n  \"status\": \"ready\",\n  \"components\": {\n    \"database\": \"connected\",\n    \"cache\": \"connected\",\n    \"message_queue\": \"connected\"\n  },\n  \"timestamp\": \"2025-12-13T09:00:00Z\"\n}\n```\n\nОтвет при неготовности (503 Service Unavailable):\n```json\n{\n  \"status\": \"not_ready\",\n  \"components\": {\n    \"database\": \"disconnected\",\n    \"cache\": \"connected\",\n    \"message_queue\": \"connected\"\n  },\n  \"error\": \"Waiting for database connection\"\n}\n```\n\n### Startup Probe\n\nПроверяет завершение инициализации контейнера. Используется для долгой инициализации.\n\n```\nGET /api/v1/health/startup\n```\n\n## Детальная диагностика\n\nGET запрос на `/api/v1/health/detailed` для полной диагностики:\n\n```\nGET /api/v1/health/detailed\nAuthorization: Bearer <token>\n```\n\nОтвет:\n\n```json\n{\n  \"status\": \"healthy\",\n  \"timestamp\": \"2025-12-13T09:00:00Z\",\n  \"uptime_seconds\": 604800,\n  \"components\": {\n    \"api_server\": {\n      \"status\": \"healthy\",\n      \"response_time_ms\": 5,\n      \"memory_usage_mb\": 128\n    },\n    \"database\": {\n      \"status\": \"healthy\",\n      \"connections_active\": 45,\n      \"connections_pool_size\": 100,\n      \"query_time_ms\": 12\n    },\n    \"cache\": {\n      \"status\": \"healthy\",\n      \"connected_nodes\": 3,\n      \"memory_usage_mb\": 512,\n      \"hit_rate\": 0.92\n    },\n    \"message_queue\": {\n      \"status\": \"healthy\",\n      \"queue_length\": 1234,\n      \"processing_rate\": 100\n    },\n    \"scanning_agents\": {\n      \"status\": \"healthy\",\n      \"total\": 50,\n      \"active\": 48,\n      \"idle\": 2,\n      \"failed\": 0\n    },\n    \"ai_engine\": {\n      \"status\": \"healthy\",\n      \"models_loaded\": 5,\n      \"inference_time_ms\": 250\n    }\n  },\n  \"alerts\": []\n}\n```\n\n## Системные метрики\n\nGET запрос на `/api/v1/metrics` для получения Prometheus метрик:\n\n```\nGET /api/v1/metrics\n```\n\nОтвет (формат Prometheus):\n\n```\n# HELP vulneraai_pentests_total Total number of pentests\n# TYPE vulneraai_pentests_total counter\nvulneraai_pentests_total 12345\n\n# HELP vulneraai_pentests_active Active pentests\n# TYPE vulneraai_pentests_active gauge\nvulneraai_pentests_active 42\n\n# HELP vulneraai_vulnerabilities_found Total vulnerabilities found\n# TYPE vulneraai_vulnerabilities_found counter\nvulneraai_vulnerabilities_found 98765\n\n# HELP vulneraai_api_request_duration_seconds API request duration\n# TYPE vulneraai_api_request_duration_seconds histogram\nvulneraai_api_request_duration_seconds_bucket{le=\"0.1\"} 5000\nvulneraai_api_request_duration_seconds_bucket{le=\"0.5\"} 8000\nvulneraai_api_request_duration_seconds_bucket{le=\"1.0\"} 9000\nvulneraai_api_request_duration_seconds_bucket{le=\"+Inf\"} 10000\nvulneraai_api_request_duration_seconds_sum 4500\nvulneraai_api_request_duration_seconds_count 10000\n\n# HELP vulneraai_database_connections Active database connections\n# TYPE vulneraai_database_connections gauge\nvulneraai_database_connections 45\n```\n\n##"
    },
    {
      "id": "error-handling",
      "title": "Обработка ошибок и валидация",
      "order": 60,
      "content": "# Обработка ошибок и валидация\n\n## HTTP коды состояния\n\n### 2xx Success\n\n- **200 OK** - операция выполнена успешно\n- **201 Created** - ресурс успешно создан\n\n### 4xx Client Error\n\n- **400 Bad Request** - неверные параметры запроса\n- **401 Unauthorized** - отсутствует или невалидна аутентификация\n- **403 Forbidden** - доступ запрещён\n- **404 Not Found** - ресурс не найден\n- **409 Conflict** - конфликт (например, дублирование)\n- **429 Too Many Requests** - превышен лимит запросов\n- **422 Unprocessable Entity** - ошибка валидации\n\n### 5xx Server Error\n\n- **500 Internal Server Error** - внутренняя ошибка сервера\n- **503 Service Unavailable** - сервис недоступен\n\n## Формат ошибок\n\nВсе ошибки возвращаются в стандартном формате JSON:\n\n```json\n{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"INVALID_TARGET_URL\",\n    \"message\": \"The target URL is not a valid HTTPS URL\",\n    \"details\": {\n      \"field\": \"target_url\",\n      \"value\": \"http://example.com\",\n      \"constraint\": \"must be HTTPS\"\n    }\n  },\n  \"timestamp\": \"2025-12-13T09:00:00Z\",\n  \"request_id\": \"req_123abc\"\n}\n```\n\n## Коды ошибок\n\n### Аутентификация\n\n- `UNAUTHORIZED` - отсутствует токен\n- `INVALID_TOKEN` - невалидный токен\n- `TOKEN_EXPIRED` - токен истёк\n- `INSUFFICIENT_PERMISSIONS` - недостаточно прав\n\n### Валидация\n\n- `INVALID_TARGET_URL` - неверный URL\n- `INVALID_INTENSITY` - неверная интенсивность\n- `INVALID_SCAN_TYPE` - неверный тип сканирования\n- `MISSING_REQUIRED_FIELD` - отсутствует обязательное поле\n- `FIELD_VALIDATION_ERROR` - ошибка валидации поля\n\n### Ресурсы\n\n- `PENTEST_NOT_FOUND` - пентест не найден\n- `RESOURCE_NOT_FOUND` - ресурс не найден\n- `DUPLICATE_RESOURCE` - дублирование ресурса\n- `RESOURCE_ALREADY_EXISTS` - ресурс уже существует\n\n### Rate limiting\n\n- `RATE_LIMIT_EXCEEDED` - превышен лимит запросов\n- `QUOTA_EXCEEDED` - превышена квота\n\n### Сервер\n\n- `INTERNAL_SERVER_ERROR` - внутренняя ошибка\n- `SERVICE_UNAVAILABLE` - сервис недоступен\n- `DATABASE_ERROR` - ошибка базы данных\n- `TIMEOUT` - операция истекла\n\n## Валидация входных данных\n\n### target_url\n\nДолжен быть валидный HTTPS URL:\n\n```\n✅ https://example.com\n✅ https://app.example.com\n✅ https://api.example.com:8443\n\n❌ http://example.com (must be HTTPS)\n❌ invalid-url (not a valid URL)\n❌ example.com (missing protocol)\n```\n\n### intensity\n\nДопустимые значения: `low`, `medium`, `high`, `aggressive`\n\n```json\n{\n  \"intensity\": \"high\"\n}\n```\n\n### scan_type\n\nДопустимые значения: `quick`, `full`, `api`, `mobile`\n\n```json\n{\n  \"scan_type\": \"full\"\n}\n```\n\n### vulnerability_types\n\nМассив типов уязвимостей:\n\n```json\n{\n  \"vulnerability_types\": [\n    \"sql_injection\",\n    \"xss\",\n    \"csrf\",\n    \"authentication_bypass\",\n    \"business_logic\"\n  ]\n}\n```\n\n## Strategies обработки ошибок\n\n### 1. Exponential Backoff\n\nПри сетевых ошибках повторяйте с экспоненциальной задержкой:\n\n```python\nimport time\nimport random\n\ndef call_api_with_retry(func, max_retries=5):\n    for attempt in range(max_retries):\n        try:\n            return func()\n        except NetworkError:\n            delay = (2 ** attempt) + random.uniform(0, 1)\n            if attempt < max_retries - 1:\n                time.sleep(delay)\n            else:\n                raise\n```\n\n### 2. Circuit Breaker\n\nОтключайте обращение к API при частых ошибках:\n\n```python\nclass CircuitBreaker:\n    def __init__(self, failure_threshold=5, timeout=60):\n        self.failure_count = 0\n        self.failure_threshold = failure_threshold\n        self.timeout = timeout\n        self.last_failure_time = None\n        self.state = 'closed'\n\n    def call(self, func):\n        if self.state == 'open':\n            if time.time() - self.last_failure_time > self.timeout:\n                self.state = 'half-open'\n            else:\n                raise Exception(\"Circuit breaker is open\")\n\n        try:\n            result = func()\n            self.on_success()\n            return result\n        except Exception as e:\n            self.on_failure()\n            raise\n\n    def on_failure(self):\n        self.failure_count += 1\n        self.last_failure_time = time.time()\n        if self.failure_count >= self.failure_threshold:\n            self.state = 'open'\n\n    def on_success(self):\n        self.failure_count = 0\n        self.state = 'closed'\n```\n\n### 3. Timeout handling\n\nВсегда устанавливайте timeout для запросов:\n\n```python\nimport requests\n\nresponse = requests.get(\n    'https://api.vulneraai.io/api/v1/pentests',\n    headers={'Authorization': 'Bearer ...'},\n    timeout=30  # 30 секунд\n)\n```\n\n### 4. Graceful degradation\n\nПродолжайте работу при частичном отказе сервиса:\n\n```python\ntry:\n    analytics = get_analytics()\nexcept Exception:\n    # Используем кэшированные данные\n    analytics = load_cached_analytics()\n```\n\n## Best practices\n\n1. **Обрабатывайте все типы ошибок**\n   ```python\n   try:\n       response = make_request()\n   except ConnectionError:\n       # сетевая ошибка\n   except TimeoutError:\n       # timeout\n   except ValueError:\n       # ошибка валидации\n   except Exception:\n       # прочие ошибки\n   ```\n\n2. **Логируйте ошибки с контекстом**\n   ```python\n   logger.error(\n       \"API request failed\",\n       extra={\n           'endpoint': '/api/v1/pentests',\n           'method': 'POST',\n           'status_code': 500,\n           'error_code': 'DATABASE_ERROR'\n       }\n   )\n   ```\n\n3. **Никогда не игнорируйте ошибки**\n   ```python\n   ❌ try:\n       response = requests.get(url)\n   except:\n       pass  # ❌ Не делайте так!\n\n   ✅ try:\n       response = requests.get(url)\n   except Exception as e:\n       logger.error(f\"Request failed: {e}\")\n       raise  # ✅ Выбрасывайте или обрабатывайте\n   ```\n\n4. **Используйте идентификаторы запросов**\n   ```python\n   request_id = response.headers.get('X-Request-ID')\n   logger.info(f\"Request completed\", extra={'request_id': request_id})\n   ```"
    }
  ]
}